# docker-compose.prod.yml
# =============================================================================
# VNtyper Online - Production Overrides
# =============================================================================
# This file extends docker-compose.yml with production-specific configuration:
# - Certbot service for SSL certificate management
# - HTTPS port binding (443)
# - Production environment file
# - Security hardening for certbot
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# =============================================================================

services:
  # ===========================================================================
  # Proxy - Add HTTPS port and production volumes (non-root)
  # ===========================================================================
  proxy:
    ports:
      # Map host privileged ports to container unprivileged ports
      - "80:8080"
      - "443:8443"
    volumes:
      # Production: certificates are read-write for certbot updates
      - /etc/ssl/certs/vntyper:/etc/letsencrypt
      - /var/www/certbot:/var/www/certbot
      - ./proxy/nginx.conf.template.http:/etc/nginx/templates/nginx.conf.template.http:ro
      - ./proxy/nginx.conf.template.ssl:/etc/nginx/templates/nginx.conf.template.ssl:ro
    env_file:
      - .env.production

  # ===========================================================================
  # Certbot - SSL Certificate Manager (Let's Encrypt) - Non-Root
  # ===========================================================================
  # IMPORTANT: Host directories must be writable by UID 1000:
  #   sudo chown -R 1000:1000 /etc/ssl/certs/vntyper /var/www/certbot
  certbot:
    build:
      context: ./certbot
      dockerfile: Dockerfile
    image: vntyper_certbot:1.0.0
    container_name: vntyper_certbot
    # Run as non-root certbot user (UID 1000)
    user: "1000:1000"
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Resource limits - certbot is lightweight
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    volumes:
      # Host directories must be owned by UID 1000
      - /etc/ssl/certs/vntyper:/etc/letsencrypt
      - /var/www/certbot:/var/www/certbot
    env_file:
      - .env.production
    depends_on:
      proxy:
        condition: service_healthy
    networks:
      - vntyper_network
    restart: unless-stopped

  # ===========================================================================
  # Backend Services - Production Environment File Overrides
  # ===========================================================================
  backend_api:
    env_file:
      - .env.production

  backend_worker_vntyper:
    env_file:
      - .env.production

  backend_worker_vntyper_long:
    env_file:
      - .env.production

  backend_worker:
    env_file:
      - .env.production

  backend_beat:
    env_file:
      - .env.production

networks:
  vntyper_network:
    driver: bridge
